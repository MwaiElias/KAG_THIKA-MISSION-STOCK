<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KAG Thika Mission | Stock Management</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body{font-family:'Segoe UI',sans-serif;background:#f4f4f4;margin:0}
header{background:maroon;color:#fff;padding:15px;display:flex;gap:15px;align-items:center}
header img{height:70px;background:#fff;padding:5px;border-radius:8px}
.container{max-width:900px;margin:30px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.15)}
h2{color:maroon}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc;font-size:1rem}
button{background:maroon;color:#fff;font-weight:bold;cursor:pointer}
button:hover{background:#800000}
#message{display:none;padding:10px;margin-top:10px;border-radius:6px;font-weight:bold}
.dept-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:20px}
.dept-card{border:2px solid maroon;padding:15px;border-radius:8px;text-align:center;cursor:pointer;transition:.3s}
.dept-card:hover{background:maroon;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid maroon;padding:8px;text-align:center}
th{background:maroon;color:#fff}
.action-btn{padding:6px 10px;border:none;border-radius:4px;color:#fff;cursor:pointer}
.edit-btn{background:#2980b9}
.delete-btn{background:#c0392b;margin-left:5px}
@media(max-width:600px){header{flex-direction:column;align-items:flex-start}}
</style>
</head>

<body>

<header>
  <img src="kag-logo.jpg" alt="KAG Logo">
  <div>
    <h1>KAG Thika Mission</h1>
    <p>Stock Management System</p>
  </div>
</header>

<div class="container">

<h2>Update / Edit Stock</h2>

<select id="department">
  <option value="">Select Department</option>
  <option>Hospitality</option>
  <option>Instruments</option>
  <option>Ushering</option>
  <option>Media</option>
  <option>Others</option>
</select>

<input type="text" id="item" placeholder="Item name">
<input type="number" id="qty" placeholder="Quantity">

<select id="action">
  <option value="add">Add</option>
  <option value="remove">Remove</option>
  <option value="broken">Broken / Destroyed</option>
  <option value="set">Set Quantity (Edit)</option>
</select>

<button onclick="saveStock()">Save Stock</button>
<div id="message"></div>

<h2>View Department Stock</h2>

<div class="dept-grid">
  <div class="dept-card" onclick="loadDept('Hospitality')"><i class="fas fa-mug-hot"></i><br>Hospitality</div>
  <div class="dept-card" onclick="loadDept('Instruments')"><i class="fas fa-guitar"></i><br>Instruments</div>
  <div class="dept-card" onclick="loadDept('Ushering')"><i class="fas fa-user-tie"></i><br>Ushering</div>
  <div class="dept-card" onclick="loadDept('Media')"><i class="fas fa-video"></i><br>Media</div>
  <div class="dept-card" onclick="loadDept('Others')"><i class="fas fa-box"></i><br>Others</div>
</div>

<h2 id="deptTitle" style="display:none"></h2>

<table id="tableWrap" style="display:none">
<thead>
<tr>
  <th>Item</th>
  <th>Available</th>
  <th>Broken</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="stockTable"></tbody>
</table>

</div>

<script>
const SERVER_URL = "https://script.google.com/macros/s/AKfycbzNL4PzdekzPxkZ99oGW-H2Z8uCxgAlqG6CdC7hm21jgbrtrY5Zvber1cmuGh3yGMYEOA/exec";

const departmentEl=document.getElementById("department");
const itemEl=document.getElementById("item");
const qtyEl=document.getElementById("qty");
const actionEl=document.getElementById("action");
const deptTitle=document.getElementById("deptTitle");
const tableWrap=document.getElementById("tableWrap");
const stockTable=document.getElementById("stockTable");
const messageEl=document.getElementById("message");

function showMessage(msg,error=false){
  messageEl.style.display="block";
  messageEl.innerText=msg;
  messageEl.style.background=error?"#f8d7da":"#d4edda";
  messageEl.style.color=error?"#721c24":"#155724";
  setTimeout(()=>messageEl.style.display="none",3000);
}

async function saveStock(){
  const department=departmentEl.value;
  const item=itemEl.value.trim().toLowerCase();
  const qty=Number(qtyEl.value);
  const action=actionEl.value;

  if(!department||!item||qty<0){
    showMessage("Fill all fields correctly",true);
    return;
  }

  const data=new URLSearchParams({department,item,qty,action});

  try{
    const res=await fetch(SERVER_URL,{method:"POST",body:data});
    const result=await res.json();
    if(result.status==="success"){
      showMessage(result.message);
      loadDept(department);
      itemEl.value=""; qtyEl.value=""; actionEl.value="add";
    }else{
      showMessage(result.message,true);
    }
  }catch(e){
    showMessage("Failed to update stock",true);
  }
}

async function loadDept(dept){
  deptTitle.style.display="block";
  deptTitle.innerText=dept+" Department Stock";
  tableWrap.style.display="table";

  try{
    const res=await fetch(SERVER_URL+"?department="+encodeURIComponent(dept));
    const data=await res.json();
    stockTable.innerHTML="";

    data.forEach(r=>{
      stockTable.innerHTML+=`
        <tr>
          <td>${r.item}</td>
          <td>${r.available}</td>
          <td>${r.broken}</td>
          <td>
            <button class="action-btn edit-btn" onclick="editItem('${dept}','${r.item}',${r.available})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete-btn" onclick="deleteItem('${dept}','${r.item}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>`;
    });
  }catch(e){
    showMessage("Failed to load stock",true);
  }
}

function editItem(dept,item,available){
  departmentEl.value=dept;
  itemEl.value=item;
  qtyEl.value=available;
  actionEl.value="set";
  window.scrollTo({top:0,behavior:"smooth"});
  showMessage("Editing item: set new quantity");
}

async function deleteItem(dept,item){
  if(!confirm(`Are you sure you want to delete "${item}" from ${dept}?`)) return;

  const formData=new URLSearchParams();
  formData.append("department",dept);
  formData.append("item",item);
  formData.append("action","delete");

  try{
    const res=await fetch(SERVER_URL,{method:"POST",body:formData});
    const result=await res.json();
    if(result.status==="success"){
      showMessage(result.message);
      loadDept(dept);
    }else{
      showMessage(result.message,true);
    }
  }catch(e){
    showMessage("Failed to delete item",true);
  }
}
</script>

</body>
</html>
